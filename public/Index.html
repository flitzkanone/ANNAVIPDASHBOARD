<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Render & Telegram Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="main-header">
        <h1><span class="status-indicator"></span>Log Analytics</h1>
        <div class="header-actions">
            <span id="lastUpdated"></span>
        </div>
    </header>

    <main class="dashboard-grid">
        <div class="panel panel-logs">
            <h2>Render Service Logs</h2>
            <div class="panel-content">
                <pre id="renderLogs">Verbinde mit dem Service...</pre>
            </div>
        </div>

        <div class="panel panel-telegram-list">
            <h2>Telegram Gruppen-Feed</h2>
            <div class="panel-content">
                <ul id="messageList">
                    <li>Warte auf Nachrichten...</li>
                </ul>
            </div>
        </div>

        <div class="panel panel-kpi">
            <h2>Nachrichten</h2>
            <div class="panel-content">
                <div class="kpi-value" id="messageCount">0</div>
                <div class="kpi-label">Letzte 50 Nachrichten</div>
            </div>
        </div>

        <div class="panel panel-kpi">
            <h2>Service Status</h2>
            <div class="panel-content">
                <div class="kpi-value status-text" id="serviceStatus">PRÜFE...</div>
                <div class="kpi-label" id="serviceIdLabel"></div>
            </div>
        </div>
    </main>

    <script>
        const logsElement = document.getElementById('renderLogs');
        const messagesListElement = document.getElementById('messageList');
        const messageCountElement = document.getElementById('messageCount');
        const serviceStatusElement = document.getElementById('serviceStatus');
        const serviceIdLabel = document.getElementById('serviceIdLabel');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        const statusIndicator = document.querySelector('.status-indicator');
        
        // Hole die Service-ID aus der URL zur Anzeige (optional, nice-to-have)
        const RENDER_SERVICE_ID = "<%= process.env.RENDER_SERVICE_ID %>";
        if (serviceIdLabel) {
            serviceIdLabel.textContent = `ID: ${process.env.RENDER_SERVICE_ID || 'Nicht gesetzt'}`;
        }
        
        async function fetchData() {
            const now = new Date();
            lastUpdatedElement.textContent = `Last update: ${now.toLocaleTimeString('de-DE')}`;
            
            // --- Render Logs abrufen ---
            try {
                const logsResponse = await fetch('/api/logs');
                if (!logsResponse.ok) throw new Error(`HTTP error! status: ${logsResponse.status}`);
                
                const logsText = await logsResponse.text();
                logsElement.textContent = logsText.trim() ? logsText : 'Keine neuen Logs vorhanden.';
                logsElement.scrollTop = logsElement.scrollHeight; // Immer nach unten scrollen

                serviceStatusElement.textContent = 'ONLINE';
                serviceStatusElement.className = 'kpi-value status-text status-online';
                statusIndicator.classList.add('online');

            } catch (e) {
                logsElement.textContent = 'Fehler beim Laden der Logs.\nPrüfe die Service-ID und den API-Key.';
                serviceStatusElement.textContent = 'FEHLER';
                serviceStatusElement.className = 'kpi-value status-text status-error';
                statusIndicator.classList.remove('online');
                console.error(e);
            }

            // --- Telegram Nachrichten abrufen ---
            try {
                const tgResponse = await fetch('/api/telegram-messages');
                if (!tgResponse.ok) throw new Error(`HTTP error! status: ${tgResponse.status}`);

                const messages = await tgResponse.json();
                messageCountElement.textContent = messages.length;
                
                if (messages.length === 0) {
                    messagesListElement.innerHTML = '<li class="empty">Keine Nachrichten vorhanden.</li>';
                } else {
                    messagesListElement.innerHTML = messages.map(msg => `
                        <li>
                            <div class="msg-header">
                                <strong>${msg.user}</strong>
                                <span class="msg-meta">${msg.timestamp}</span>
                            </div>
                            <p class="msg-text">${msg.text}</p>
                        </li>`).join('');
                }
            } catch (e) {
                messagesListElement.innerHTML = '<li class="empty">Fehler beim Laden der Nachrichten.</li>';
                console.error(e);
            }
        }

        // Beim Start laden und dann alle 10 Sekunden aktualisieren
        fetchData();
        setInterval(fetchData, 10000);
    </script>
</body>
</html>
