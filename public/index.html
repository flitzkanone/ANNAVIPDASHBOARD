<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Wir binden Chart.js für Diagramme ein -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="main-header">
        <h1><span class="status-indicator"></span>Analyse Dashboard</h1>
        <div class="header-actions">
            <span id="lastUpdated"></span>
        </div>
    </header>

    <main class="dashboard-grid">
        <div class="panel panel-logs">
            <h2>Render Service Logs</h2>
            <div class="panel-content">
                <pre id="renderLogs">Verbinde mit dem Service...</pre>
            </div>
        </div>

        <div class="panel panel-telegram-list">
            <h2>Telegram Live-Feed</h2>
            <div class="panel-content">
                <ul id="messageList"><li>Warte auf Nachrichten...</li></ul>
            </div>
        </div>

        <div class="panel panel-chart">
            <h2>Nutzeraktivität (Letzte 30 Tage)</h2>
            <div class="panel-content">
                <canvas id="userChart"></canvas>
            </div>
        </div>
        
        <div class="panel panel-list">
            <h2>Nutzerliste</h2>
            <div class="panel-content" id="userListWrapper">
                <ul id="userList"><li>Lade...</li></ul>
            </div>
        </div>

        <div class="panel panel-kpi-group">
            <h2>Aktions-Statistik</h2>
            <div class="kpi-grid">
                <div class="kpi-item">
                    <span class="kpi-value" id="val5">0</span>
                    <span class="kpi-label">5€ Aktionen</span>
                </div>
                 <div class="kpi-item">
                    <span class="kpi-value" id="val10">0</span>
                    <span class="kpi-label">10€ Aktionen</span>
                </div>
                 <div class="kpi-item">
                    <span class="kpi-value" id="val15">0</span>
                    <span class="kpi-label">15€ Aktionen</span>
                </div>
                 <div class="kpi-item">
                    <span class="kpi-value" id="val25">0</span>
                    <span class="kpi-label">25€ Aktionen</span>
                </div>
                 <div class="kpi-item">
                    <span class="kpi-value" id="val30">0</span>
                    <span class="kpi-label">30€ Aktionen</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // DOM Elemente
        const logsElement = document.getElementById('renderLogs');
        const messageListElement = document.getElementById('messageList');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        const statusIndicator = document.querySelector('.status-indicator');
        const userListElement = document.getElementById('userList');
        
        let userChartInstance = null;

        async function fetchData() {
            const now = new Date();
            lastUpdatedElement.textContent = `Last update: ${now.toLocaleTimeString('de-DE')}`;
            
            // --- Render Logs abrufen ---
            try {
                const logsResponse = await fetch('/api/logs');
                if (!logsResponse.ok) throw new Error();
                const logsText = await logsResponse.text();
                logsElement.textContent = logsText.trim() ? logsText : 'Keine neuen Logs vorhanden.';
                logsElement.scrollTop = logsElement.scrollHeight;
                statusIndicator.classList.add('online');
            } catch (e) {
                logsElement.textContent = 'Fehler beim Laden der Logs.';
                statusIndicator.classList.remove('online');
            }

            // --- Statistiken und Nachrichten abrufen ---
            try {
                const statsResponse = await fetch('/api/stats');
                if (!statsResponse.ok) throw new Error();
                const { rawMessages, stats } = await statsResponse.json();

                // Telegram Feed aktualisieren
                messageListElement.innerHTML = rawMessages.length > 0
                    ? rawMessages.map(msg => `<li><div class="msg-header"><strong>${msg.user}</strong><span class="msg-meta">${msg.timestamp}</span></div><p class="msg-text">${msg.text}</p></li>`).join('')
                    : '<li class="empty">Keine Nachrichten vorhanden.</li>';

                // Aktions-Statistik aktualisieren
                document.getElementById('val5').textContent = stats.actionCounts[5];
                document.getElementById('val10').textContent = stats.actionCounts[10];
                document.getElementById('val15').textContent = stats.actionCounts[15];
                document.getElementById('val25').textContent = stats.actionCounts[25];
                document.getElementById('val30').textContent = stats.actionCounts[30];

                // Nutzerliste aktualisieren
                userListElement.innerHTML = stats.userList.length > 0
                    ? stats.userList.map(user => `<li><span>${user.name}</span><span class="user-id">${user.id}</span></li>`).join('')
                    : '<li class="empty">Noch keine Nutzer erfasst.</li>';
                
                // Nutzer-Chart aktualisieren
                updateUserChart(stats.userGrowth);

            } catch (e) {
                console.error("Fehler beim Abrufen der Stats:", e);
            }
        }

        function updateUserChart(data) {
            const ctx = document.getElementById('userChart').getContext('2d');
            const labels = Object.keys(data);
            const values = Object.values(data);
            
            if (userChartInstance) {
                userChartInstance.data.labels = labels;
                userChartInstance.data.datasets[0].data = values;
                userChartInstance.update();
            } else {
                userChartInstance = new Chart(ctx, {
                    type: 'bar', // 'line' oder 'bar'
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Aktive Nutzer pro Tag',
                            data: values,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            fill: true,
                        }]
                    },
                    options: {
                        scales: { y: { beginAtZero: true, ticks: { color: '#cbd5e1' } }, x: { ticks: { color: '#cbd5e1' } } },
                        plugins: { legend: { labels: { color: '#cbd5e1' } } },
                        maintainAspectRatio: false
                    }
                });
            }
        }

        fetchData();
        setInterval(fetchData, 15000); // Intervall auf 15s erhöhen
    </script>
</body>
</html>
